# Инструкция по настройке авторизации через Яндекс ID

## Шаг 1: Регистрация приложения в Яндекс ID

1. Перейдите на [https://oauth.yandex.ru/client/new](https://oauth.yandex.ru/client/new)
2. Заполните форму:
   - **Название приложения**: Ваш сайт (например, "Админ-панель магазина")
   - **Описание**: Система управления товарами
   - **Права**:
     - ✅ `login:email` - доступ к email пользователя
     - ✅ `login:info` - доступ к основной информации
   - **Callback URL**: `http://localhost/site/yandex_callback.php`
   - **Diagnostics**: Не отмечайте

3. Нажмите "Создать приложение"
4. Сохраните **Client ID** и **Client Secret**

## Шаг 2: Настройка конфигурации

1. Откройте файл `config_yandex.php`
2. Замените значения:
   ```php
   define('YANDEX_CLIENT_ID', 'ВАШ_CLIENT_ID');
   define('YANDEX_CLIENT_SECRET', 'ВАШ_CLIENT_SECRET');
   ```

## Шаг 3: Обновление базы данных

1. Выполните SQL из файла `update_database.sql`:
   ```sql
   ALTER TABLE admins 
   ADD COLUMN yandex_id VARCHAR(50) NULL UNIQUE AFTER username,
   ADD COLUMN email VARCHAR(255) NULL AFTER password,
   ADD COLUMN last_login DATETIME NULL AFTER email,
   ADD COLUMN created_at DATETIME NULL DEFAULT CURRENT_TIMESTAMP AFTER last_login;
   ```

## Шаг 4: Проверка работы

1. Откройте страницу авторизации: `http://localhost/site/auth.php`
2. Нажмите "Авторизоваться через Яндекс"
3. Разрешите доступ приложению
4. Вы должны быть перенаправлены в админ-панель

## Как это работает:

1. **Пользователь нажимает кнопку** → перенаправление на Яндекс
2. **Яндекс запрашивает разрешение** → пользователь соглашается
3. **Яндекс возвращает код** → обмен на токен доступа
4. **Получение данных пользователя** → создание/обновление записи в БД
5. **Установка сессии** → вход в систему

## Безопасность:

- ✅ CSRF защита через `state` параметр
- ✅ Валидация токена доступа
- ✅ Проверка HTTP статусов
- ✅ Безопасное хранение в сессии

## Возможные ошибки:

- `yandex_cancelled` - пользователь отменил авторизацию
- `yandex_token_failed` - ошибка получения токена
- `yandex_user_info_failed` - ошибка получения данных
- `database_error` - ошибка базы данных

## Дополнительная информация:

- Пользователи Яндекса создаются автоматически
- Логин формата: `yandex_123456789`
- Email сохраняется из профиля Яндекса
- Пароль генерируется автоматически (не используется)
